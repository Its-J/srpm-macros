## Define cache directory for NPM
%_npm_cache_dir %{rpmbuilddir}/.npm

## Common env vars to be used for all NPM and descendents' macros
## NPM will default to the PROJECT SET config when environment variables are set in uppercase. This is intentional behavior and we don't override it as some build scripts rely on setting these variables to specific values. If you want to explicitly override all commands with these build flags, please use %%npm_buildflags in your calls to NPM.
## For more information on the differences between uppercase and lowercase environment variables in Node.js and NPM, see https://github.com/npm/npm/issues/14528
## Reference: https://docs.npmjs.com/cli/v11/using-npm/config
%npm_common_envvars NPM_CONFIG_USERCONFIG=%{rpmbuilddir}/.npmrc NPM_CONFIG_GLOBALCONFIG=%{rpmbuilddir}/npmrc NPM_CONFIG_CACHE=%{_npm_cache_dir} NPM_CONFIG_LOGLEVEL=error NPM_CONFIG_FUND=false NPM_CONFIG_UPDATE_NOTIFIER=false NO_UPDATE_NOTIFIER=1 NPM_CONFIG_COLOR=always NPM_CONFIG_INIT_MODULE=%{rpmbuilddir}/.npm-init.js

## Define cache directory for Bun
## Currently Bun doesn't respect this, tracking issue here: https://github.com/oven-sh/bun/issues/10152
%_bun_cache_dir %{rpmbuilddir}/.bun

## Common env vars for Bun
## While Bun itself doesn't use NPM env vars directly (and is its own JavaScript runtime independent to Node.js), some Node module build deps such as Electron Builder do
%bun_common_envvars %{npm_common_envvars} BUN_HOME=%{_bun_cache_dir} BUN_RUNTIME_TRANSPILER_CACHE_PATH=0

## Define cache directory for PNPM
%_pnpm_cache_dir %{rpmbuilddir}/.pnpm

## Common env vars for PNPM
## While PNPM itself doesn't use NPM env vars directly, some Node module build deps such as Electron Builder do
%pnpm_common_envvars %{npm_common_envvars} PNPM_HOME=%{_pnpm_cache_dir}

## Define cache directory for Yarn
%_yarn_cache_dir %{rpmbuilddir}/.yarn

## Common env vars for Yarn
## While Yarn itself doesn't use NPM env vars directly, some Node module build deps such as Electron Builder do
%yarn_common_envvars %{npm_common_envvars} YARN_CACHE_FOLDER=%{_yarn_cache_dir}

## Build flags for NPM so they can be called independently to force our build config.
%npm_buildflags --userconfig=%{rpmbuilddir}/.npmrc --globalconfig=%{rpmbuilddir}/npmrc --cache=%{rpmbuilddir}/.npm --loglevel=error --fund=false --update-notifier=false --color=always --init-module=%{rpmbuilddir}/.npm-init.js

## Define NVM cache/vendored Node.js install directory
%_nvm_dir %{rpmbuilddir}/.nvm

## Call NPM with our build env vars
%__npm /usr/bin/env %{npm_common_envvars} %{?with_vendored_nodejs:%{_vendored_nodejs_dir}/npm}%{!?with_vendored_nodejs:/usr/bin/npm}

## Remotely execute a Node module from the NPM Registry with NPM
## NOTE: NPX can escape the variables of the main shell in some situations. It may be necessary to call NPM from NPX with %%npm_buildflags set for consistent behavior.
%__npx /usr/bin/env %{npm_common_envvars} %{?with_vendored_nodejs:%{_vendored_nodejs_dir}/npx}%{!?with_vendored_nodejs:/usr/bin/npx}

## Macro to make sure system installed NVM uses the correct directory when used in %%vendor_nodejs.
%__nvm /usr/bin/env NVM_DIR=%{_nvm_dir} /usr/bin/nvm

## Call Bun with our build env vars
%__bun /usr/bin/env %{bun_common_envvars} /usr/bin/bun

## Execute a Node module in the Bun build environment (installing it if it isn't present)
%__bunx /usr/bin/env %{bun_common_envvars} /usr/bin/bunx

## Call PNPM with our build env vars
%__pnpm /usr/bin/env %{pnpm_common_envvars} %{?with_vendored_pnpm:%{_pnpm_cache_dir}/pnpm}%{!?with_vendored_pnpm:/usr/bin/pnpm}

## Remotely execute a Node module from the NPM Registry with PNPM
%__pnpx /usr/bin/env %{pnpm_common_envvars} %{?with_vendored_pnpm:%{_pnpm_cache_dir}/pnpx}%{!?with_vendored_pnpm:/usr/bin/pnpx}

## Call Yarn with our build env vars
%__yarn /usr/bin/env %{yarn_common_envvars} /usr/bin/yarn

## Remotely execute a Node module from the NPM Registry with Yarn
## NOTE: Yarn DLX (Yarn's equivalent to NPX, PNPX, and Bunx) only exists in Yarn Berry!
## If you need to use this feature, make sure you use BuildRequires: yarnpkg-berry
%__yarn_dlx %{__yarn} dlx

## ONLY use if Node.js is not usable from the repos for some reason (such as needing non-LTS Node.js)
# -v: "Version." The version of Node.js to install. Required flag.
%vendor_nodejs(v:)                                                                    \
%{!?-v*:%{error:Node.js version to install required to be passed using the -v flag.}} \
touch "$HOME/.bash_profile" &>/dev/null                                               \
nvm install %{?-v*}                                                                   \
%{lua:
if #macros["-v*"] < 3 then
  rpm.define("__nodejs " .. rpm.expand("%{_nvm_dir}/versions/node/v%{-v*}") .. "*/bin/node")
  rpm.define("_vendored_nodejs_dir " .. rpm.expand("%{_nvm_dir}/versions/node/v%{-v*}") .. "*/bin")
else
  rpm.define("__nodejs " .. rpm.expand("%{_nvm_dir}/versions/node/v%{-v*}") .. "/bin/node")
  rpm.define("_vendored_nodejs_dir " .. rpm.expand("%{_nvm_dir}/versions/node/v%{-v*}") .. "/bin")
end}                                                                                  \
%bcond vendored_nodejs 1

## ONLY use if PNPM is not usable from the repos for some reason
# -v "Version." Choose a specific version of PNPM to vendor
%vendor_pnpm(v:)                                                 \
export PNPM_HOME="%{_pnpm_cache_dir}"                            \
curl -fsSL https://get.pnpm.io/install.sh | sh - >/dev/null 2>&1 \
%{?-v:%{_pnpm_cache_dir}/pnpm env use --global %{-v*}}           \
%bcond vendored_pnpm 1

## Export Node module related build flags globally if necessary for any reason.
## Based on Fedora's %%set_build_flags and can be used the same way or in combination with it.
## Also creates a variable that can be called for our NPM build flags, similar to how Fedora supplies buildflags in both variables and macros.
%set_node_build_flags \
NPM_CONFIG_USERCONFIG="%{rpmbuilddir}/.npmrc" ; export NPM_CONFIG_USERCONFIG ; \
NPM_CONFIG_GLOBALCONFIG="%{rpmbuilddir}/npmrc" ; export NPM_CONFIG_GLOBALCONFIG ; \
NPM_CONFIG_CACHE="%{_npm_cache_dir}" ; export NPM_CONFIG_CACHE ; \
NPM_CONFIG_LOGLEVEL="error" ; export NPM_CONFIG_LOGLEVEL ; \
NPM_CONFIG_FUND="false" ; export NPM_CONFIG_FUND ; \
NPM_CONFIG_UPDATE_NOTIFIER="false" ; export NPM_CONFIG_UPDATE_NOTIFIER ; \
NO_UPDATE_NOTIFIER="1" ; export NO_UPDATE_NOTIFIER ; \
NPM_CONFIG_COLOR="always" ; export NPM_CONFIG_COLOR ; \
NPM_CONFIG_INIT_MODULE="%{rpmbuilddir}/.npm-init.js" ; export NPM_CONFIG_INIT_MODULE ; \
BUN_HOME="%{_bun_cache_dir}" ; export BUN_HOME ; \
BUN_RUNTIME_TRANSPILER_CACHE_PATH="0" ; export BUN_RUNTIME_TRANSPILER_CACHE_PATH ; \
PNPM_HOME="%{_pnpm_cache_dir}" ; export PNPM_HOME ; \
YARN_CACHE_FOLDER="%{_yarn_cache_dir}" ; export YARN_CACHE_FOLDER ; \
NPMFLAGS="${NPMFLAGS:-%{npm_buildflags} }" ; export NPMFLAGS

## These macros REQUIRE that the macro %%npm_name be defined or the module be passed to them

## For use in prep section
## WARNING: Do NOT use in the prep section of projects using NPM that are not Node.js packages!
# -n: "Name." Must be the CANONICAL name of the Node module as hosted on the NPM Registry
# %%npm_prep -n nodepkgname
%npm_prep(n:) %{lua:
   if opt.n then
     rpm.define("npm_name " .. rpm.expand("%{-n*}"))
   end
   if not rpm.isdefined("npm_name") then
     error("%npm_name is not defined. Please define it using a global macro or with the -n flag.")
   end}                                                      \
%{__npm} install -g %{npm_name}@%{version} --prefix="$(pwd)" \
%setup -T -D -n lib/node_modules/%{npm_name}

## Fetch the Node tests within the spec. Uses Git commands that ONLY download specified directories
## Files in the root of the repository need only their name
## URL MAY include ".git" when using -u flag
# -u: "URL." This MUST be set if the URL used in the spec is not automatically detectable as a clonable Git repository
# %%fetch_node_tests -u https://github.com/nodepkgdev/nodepkgname /tests .eslintrc.json
%fetch_node_tests(u:) %{lua:
  cmd = rpm.expand("%{__git} clone -n --depth=1 --filter=tree:0 -q %{?_smp_mflags} ")
  if not arg[1] then error("Test folders/files not specified. Please list them, separated by spaces.") end
  for i, file in ipairs(arg) do
    if file:find('/') and string.sub(file, 1, 1) ~= '/' then
      error("Folders holding test files must start with '/'")
    end
  end
  macros["_nodetests"] = table.concat(arg, " ")
  srcdir = macros["rpmbuilddir"] .. "/sourcetests"
  macros["_nodetestdir"] = srcdir
  if (rpm.expand("%{?url}"):find('git') or rpm.expand("%{?url}"):find('codeberg')) and not opt.u then
    print(cmd .. rpm.expand("%{url} ") .. srcdir .. ' && cd ' .. srcdir)
  elseif opt.u then
    if rpm.expand("%{-u*}"):find('://') and rpm.expand("%{-u*}"):find('.') then
      print(cmd .. rpm.expand("%{-u*} ") .. srcdir .. ' && cd ' .. srcdir)
    else
      error("-u argument could not be detected as a clonable URL. Please make sure it is in the format of 'https://github.com/repo/project' or try adding '.git' to the end.")
    end
  else
    error("URL could not be automatically identified as clonable and -u is not set. Please set a Git repository hosting the tests for this module using the -u option.")
  end}                                                 \
  %{__git} switch -c v%{version} -q                    \
  %{__git} sparse-checkout set --no-cone %{_nodetests} \
  %{__git} checkout -q                                 \
  cd ~-

## Install package to %%nodejs_sitelib or %%nodejs_sitearch.
# -s: "Symlink." Install bindir symlink as a different name than the %%npm_name.
%npm_install(s:) %{lua:
  if not rpm.isdefined("npm_name") or not (rpm.isdefined("buildsubdir") and not rpm.isdefined("_buildsubdir")) then
    error("Package has not been prepped! Please run %npm_prep first.")
  end
  if opt.s then
    rpm.define("node_bin_symlink %{-s*}")
  else
    rpm.define("node_bin_symlink %{npm_name}")
  end}                                                         \
if stat ./bin/%{npm_name}.js &>/dev/null; then                 \
  _js=".js"                                                    \
fi                                                             \
if [[ "%{_target_cpu}" != "noarch" ]]; then                    \
  BUILDINSTALLDIR="%{buildroot}%{nodejs_sitearch}/%{npm_name}" \
  INSTALLDIR="%{nodejs_sitearch}/%{npm_name}"                  \
else                                                           \
  BUILDINSTALLDIR="%{buildroot}%{nodejs_sitelib}/%{npm_name}"  \
  INSTALLDIR="%{nodejs_sitelib}/%{npm_name}"                   \
fi                                                             \
%{__mkdir} -p "$BUILDINSTALLDIR"                               \
%{__mkdir} -p "%{buildroot}%{_bindir}"                         \
%{__cp} -r ./* -t "$BUILDINSTALLDIR"                           \
%{__ln_s}f "$INSTALLDIR/bin/%{npm_name}$_js" %{buildroot}%{_bindir}/%{node_bin_symlink}

## Best used in check section
## This will fail if ANY security vulnerabilities are found. It SHOULD NOT fail for other issues.
%npm_audit()                        \
   (                                \
   set -euo pipefail                \
   %{__npm} audit --audit-level=low \
   )

## Best used in prep section if check fails
## Reference: https://docs.npmjs.com/cli/v11/commands/npm-audit
## LIMITATION: Cannot be used for packages that would require a package lock as you can't lock packages installed with the -g flag
# -d can be used to check what it will do before running, especially if using -f
# -f should ONLY be used if absolutely necessary and SHOULD be tested locally on the module first, as it will potentially break dependencies
%npm_audit_fix(dfo:O:p)                              \
   (                                                 \
   set -euo pipefail                                 \
   %{__npm} audit fix %{shrink:                      \
   %{-d:--dry-run}                                   \
   %{-f:--force}                                     \
   %{-o:--omit=%{-o*}}                               \
   %{-O:--only=%{-O*}}                               \
   %{-p:--package-lock-only}                         \
   %{nil}                                            \
}                                                    \
)

## For use in check section
## ONLY use if package uses bundled Node dependencies.
## NOTE: Technically Bun audit is a wrapper for NPM audit, however it unfortunately lacks the ability to FIX vulnerabilities
## There is no timeline for this being implemented, but there is a tracking issue: https://github.com/oven-sh/bun/issues/20238
## For now, you need to fix vulnerabilities, please see %%npm_audit_fix
# NOTE: While alarming, if the audit fails on a dependency that is NOT bundled in the final program, you can ignore it.
%bun_audit() NPM_CONFIG_AUDIT_LEVEL=low %{__bun} audit

## For use in check section
## ONLY use if package uses bundled Node dependencies.
## NOTE: While alarming, if the audit fails on a dependency that is NOT bundled in the final program, you can ignore it.
%pnpm_audit() NPM_CONFIG_AUDIT_LEVEL=low %{__pnpm} audit

## Fix dependencies using PNPM.
## WARNING: Does NOT support all the options NPM audit fix does. It may be preferable to use that instead as this will also fix build dependencies.
%pnpm_audit_fix() NPM_CONFIG_AUDIT_LEVEL=low %{__pnpm} audit --fix

## Approve dependency scripts with Bun if needed.
# -a: "All." Approve all scripts. Use with caution.
# Example: %%bun_pm_trust pkg1 pkg2
%bun_pm_trust(a) \
%{lua:
if not opt.a and not arg[1] then
  error("bun pm trust requires package names or -a for --all")
elseif not opt.a then
  print(rpm.expand("%{__bun} pm trust"))
  for i, cmd in ipairs(arg) do
    print(" " .. cmd)
  end
  print("\\n")
elseif opt.a then
  print(rpm.expand("%{__bun} pm trust --all"))
end}

## Approve dependency scripts with PNPM if needed.
# -g: Direct duplicate of "-g" (global).
%pnpm_approve_builds(g) %{__pnpm} approve-builds %{-g:-g}

## For use in check section
## ONLY use if package uses bundled Node dependencies.
## Unfortunately, like Bun, Yarn lacks a built in way to fix vulnerabilities.
## If you need to fix vulnerabilities, please see %%npm_audit_fix
## NOTE: While alarming, if the audit fails on a dependency that is NOT bundled in the final program, you can ignore it.
%yarn_audit() NPM_CONFIG_AUDIT_LEVEL=low %{__yarn} audit

## Below require nodejs-license-checker as a build dep

## Make this a macro so it can be called on its own for any reason
%__npm_license_checker() /usr/bin/license-checker

## Outputs a summary of the licenses used in the main package and bundled dependencies
## Useful for filling out the License section
%npm_license_summary() %{__npm_license_checker} --summary

## Outputs all used licenses and removes all irrelevent info, especially paths
## Since this is a license file, the repository and publisher information have been removed, but they SHOULD ALWAYS be left in an unaltered state in the bundled module
# -o: "Output." Output licenses to a selected file. Copy of "--out."
%npm_license(o:) %{__npm_license_checker} --limitAttributes licenses %{-o:--out %{-o*}}

## Only applicable if a test folder is provided from a source repo using %%fetch_node_tests
## Please note that many Node.js projects have test methods that cannot be covered by this macro such as ones that should be run by Node.js itself
## Other tests include Mocha, Yarn, ESLint, and more that MAY be possible to accomodate with some more research and testing
# -R: Direct duplicate of -R flag. Project dependent.
# -v: Direct duplicate of -v flag. Project dependent.
%node_self_test(Rv)                                                       \
   for test in %{?_nodetests}; do                                         \
      if [[ $test == /* ]]; then                                          \
        NODE_ENV=test %{buildroot}%{_bindir}/%{node_bin_symlink}%{shrink: \
        %{-R:-R}                                                          \
        %{-v:-v}                                                          \
        } %{_nodetestdir}$test                                            \
      fi                                                                  \
   done

## Generic NPM tests
%npm_test()      \
   %{__npm} test
